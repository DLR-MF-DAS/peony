#!/usr/bin/env python
# -*- coding: utf-8 -*-

from peony.inference import bayesian_inference_on_geotiff
import click
import json
import numpy as np

def json_to_likelihood(data):
    def likelihood_function(evidence, hypothesis):
        likelihood = np.zeros(hypothesis.shape)
        evidence = evidence[0]
        for key in data:
            matches = np.nonzero(evidence == int(key))
            likelihood[:, matches[0], matches[1]] = np.transpose(np.repeat(np.array(data[key]), matches[0].shape[0], axis=0))
            likelihood[np.argwhere(evidence == int(key))] = np.array(data[key])
        return likelihood
    return likelihood_function

@click.command()
@click.option("-h", "--hypothesis", help="Path to the GeoTIFF with the hypothesis probability distribution")
@click.option("-e", "--evidence", help="Path to the evidence data")
@click.option("-p", "--posterior", help="Name of the file to write the posterior distribution")
@click.option("-l", "--likelihood", help="YAML with the likelihood transformation")
def main(hypothesis, evidence, posterior, likelihood):
    with open(likelihood, 'r') as fd:
        likelihood_data = json.load(fd)
    bayesian_inference_on_geotiff(hypothesis, evidence, posterior, json_to_likelihood(likelihood_data))


if __name__ == '__main__':
    main()

