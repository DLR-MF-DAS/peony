#!/usr/bin/env python
# -*- coding: utf-8 -*-

from peony.db import query_polygon
import click
from jinja2 import Template

@click.command()
@click.option("-p", "--polygon", help="GeoJSON file with a polygon of interest", required=True)
@click.option("-d", "--database", help="SQLite file with the metadata database", required=True)
@click.option("-i", "--template", help="Jinja2 template file to fill in with file names")
@click.option("-o", "--output", help="Output file constructed from the user specified template")
@click.option("--date-range", help="Date range for the query (dd.mm.yyyy-dd.mm.yyyy format)", default=None)
def main(polygon, database, template, output, date_range):
    if date_range is not None:
        import datetime
        date_pair = date_range.strip().split('-')
        date_pair = (datetime.datetime.strptime(date_pair[0], '%d.%m.%Y'),
                     datetime.datetime.strptime(date_pair[1], '%d.%m.%Y'))
    else:
        date_pair = None
    result = query_polygon(database, polygon, date_pair)
    if template is None:
        for tup in result:
            print(tup[0], tup[1], tup[2])
    else:
        with open(template, 'r') as fd:
            j2_template = Template(fd.read())
        with open(output, 'w') as fd:
            fd.write(j2_template.render({'filenames' : result}))

if __name__ == '__main__':
    main()


